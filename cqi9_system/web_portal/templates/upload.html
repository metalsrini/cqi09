{% extends "layout.html" %}

{% block extra_css %}
<style>
    .pdf-preview {
        max-height: 500px;
        overflow-y: auto;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-bottom: 20px;
    }
    .preview-section {
        display: none;
    }
    .upload-zone {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 50px 20px;
        text-align: center;
        background-color: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: #007bff;
        background-color: #e9ecef;
    }
    .upload-zone i {
        font-size: 48px;
        margin-bottom: 15px;
        color: #6c757d;
    }
    .extraction-progress {
        display: none;
    }
    .data-summary {
        margin-bottom: 20px;
    }
    .data-summary .card-header {
        font-weight: 500;
    }
    .data-field {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
    }
    .field-name {
        font-weight: 500;
        color: #495057;
    }
    .field-value {
        color: #212529;
    }
    .requirements-list {
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.9rem;
    }
    .req-item {
        padding: 6px 0;
        border-bottom: 1px solid #eee;
    }
    .req-item:last-child {
        border-bottom: none;
    }
    .req-id {
        font-weight: 500;
        display: inline-block;
        min-width: 40px;
    }
    .req-evidence {
        color: #495057;
        word-break: break-word;
    }
    .extraction-stats {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 10px;
    }
    .data-quality-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .quality-high {
        background-color: #28a745;
    }
    .quality-medium {
        background-color: #ffc107;
    }
    .quality-low {
        background-color: #dc3545;
    }
    .error-message {
        color: #dc3545;
        margin-top: 10px;
    }
    .success-message {
        color: #28a745;
        margin-top: 10px;
    }
    .spinner-border {
        width: 1rem;
        height: 1rem;
        margin-right: 0.5rem;
    }
    .extraction-tip {
        margin-top: 20px;
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-left: 4px solid #17a2b8;
        font-size: 0.9rem;
    }
    .empty-section-help {
        padding: 8px;
        background-color: #fff3cd;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1 class="h2">Upload CQI-9 Audit</h1>
            <div>
                <a href="{{ url_for('new_audit') }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-plus me-1"></i> Create New Audit
                </a>
                <a href="{{ url_for('list_audits') }}" class="btn btn-outline-primary">
                    <i class="fas fa-list me-1"></i> View All Audits
                </a>
            </div>
        </div>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="uploadTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="true">
                                <i class="fas fa-upload me-1"></i> Upload PDF
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">
                                <i class="fas fa-eye me-1"></i> Preview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button" role="tab" aria-controls="import" aria-selected="false">
                                <i class="fas fa-file-import me-1"></i> Import Data
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="uploadTabsContent">
                        <!-- Upload Tab -->
                        <div class="tab-pane fade show active" id="upload" role="tabpanel" aria-labelledby="upload-tab">
                            <div class="row">
                                <div class="col-md-8 mx-auto">
                                    <div class="mb-4">
                                        <h4 class="mb-3">Upload CQI-9 Audit PDF</h4>
                                        <p class="text-muted">Upload a completed CQI-9 audit PDF file to automatically extract and import the data into the system. The system will attempt to identify key information from the PDF and populate the audit form.</p>
                                    </div>
                                    
                                    <form id="uploadForm" action="{{ url_for('upload_audit') }}" method="post" enctype="multipart/form-data">
                                        <div class="upload-zone" id="dropZone">
                                            <i class="fas fa-file-pdf"></i>
                                            <h5>Drag & Drop your PDF file here</h5>
                                            <p class="text-muted">or</p>
                                            <input type="file" id="pdfFile" name="pdf_file" accept=".pdf" class="d-none">
                                            <button type="button" id="browseButton" class="btn btn-primary">Browse Files</button>
                                        </div>
                                        
                                        <div class="selected-file mt-3" style="display: none;">
                                            <div class="alert alert-info d-flex align-items-center">
                                                <i class="fas fa-file-pdf me-2"></i>
                                                <span id="fileName">No file selected</span>
                                                <button type="button" class="btn-close ms-auto" id="removeFile" aria-label="Remove"></button>
                                            </div>
                                        </div>
                                        
                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="checkbox" id="templateModeCheck">
                                            <label class="form-check-label" for="templateModeCheck">
                                                Use template mode (skip extraction)
                                            </label>
                                            <small class="form-text text-muted d-block">
                                                Select this option if you're having trouble with PDF extraction or prefer to enter data manually
                                            </small>
                                        </div>
                                        
                                        <div class="mt-4 d-flex justify-content-between">
                                            <button type="button" class="btn btn-secondary" id="cancelUpload">Cancel</button>
                                            <button type="button" class="btn btn-primary" id="extractButton" disabled>
                                                <i class="fas fa-magic me-1"></i> Extract Data
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <div class="extraction-progress mt-4">
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                        </div>
                                        <p class="text-center mt-2">Extracting data from PDF, please wait...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview Tab -->
                        <div class="tab-pane fade preview-section" id="preview" role="tabpanel" aria-labelledby="preview-tab">
                            <div class="row">
                                <div class="col-12">
                                    <h4 class="mb-3">PDF Content Preview</h4>
                                    <p class="text-muted">Below is the extracted text content from your PDF file. This is what the system will analyze to extract audit data.</p>
                                    
                                    <div class="pdf-preview" id="pdfTextPreview">
                                        <div class="text-center text-muted py-5">
                                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                                            <p>No PDF content to preview yet. Please upload a file first.</p>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary" id="backToUpload">
                                            <i class="fas fa-arrow-left me-1"></i> Back
                                        </button>
                                        <button type="button" class="btn btn-primary" id="continueToImport">
                                            Continue <i class="fas fa-arrow-right ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Import Tab -->
                        <div class="tab-pane fade preview-section" id="import" role="tabpanel" aria-labelledby="import-tab">
                            <div class="row">
                                <div class="col-12">
                                    <h4 class="mb-3">Extracted Data Summary</h4>
                                    <p class="text-muted">Review the data extracted from your PDF file before importing it into the system.</p>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card data-summary mb-3">
                                                <div class="card-header">Organization Information</div>
                                                <div class="card-body" id="orgDataSummary">
                                                    <div class="text-center text-muted py-3">
                                                        <p>No data extracted yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="card data-summary mb-3">
                                                <div class="card-header">Job Audit Information</div>
                                                <div class="card-body" id="jobDataSummary">
                                                    <div class="text-center text-muted py-3">
                                                        <p>No data extracted yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card data-summary mb-3">
                                                <div class="card-header">Section 1 Requirements</div>
                                                <div class="card-body" id="section1Summary">
                                                    <div class="text-center text-muted py-3">
                                                        <p>No data extracted yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card data-summary mb-3">
                                                <div class="card-header">Section 2 Requirements</div>
                                                <div class="card-body" id="section2Summary">
                                                    <div class="text-center text-muted py-3">
                                                        <p>No data extracted yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card data-summary mb-3">
                                                <div class="card-header">Section 3 Requirements</div>
                                                <div class="card-body" id="section3Summary">
                                                    <div class="text-center text-muted py-3">
                                                        <p>No data extracted yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Note:</strong> Data extraction from PDFs is not always perfect. Please review the extracted information and make any necessary corrections after importing.
                                    </div>
                                    
                                    <div class="mt-4 d-flex justify-content-between">
                                        <button type="button" class="btn btn-secondary" id="backToPreview">
                                            <i class="fas fa-arrow-left me-1"></i> Back
                                        </button>
                                        <button type="button" class="btn btn-success" id="importButton">
                                            <i class="fas fa-file-import me-1"></i> Import Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const dropZone = document.getElementById('dropZone');
        const browseButton = document.getElementById('browseButton');
        const pdfFileInput = document.getElementById('pdfFile');
        const fileName = document.getElementById('fileName');
        const selectedFile = document.querySelector('.selected-file');
        const removeFileButton = document.getElementById('removeFile');
        const extractButton = document.getElementById('extractButton');
        const cancelUpload = document.getElementById('cancelUpload');
        const uploadTab = document.getElementById('upload-tab');
        const previewTab = document.getElementById('preview-tab');
        const importTab = document.getElementById('import-tab');
        const backToUpload = document.getElementById('backToUpload');
        const backToPreview = document.getElementById('backToPreview');
        const continueToImport = document.getElementById('continueToImport');
        const importButton = document.getElementById('importButton');
        const extractionProgress = document.querySelector('.extraction-progress');
        const pdfTextPreview = document.getElementById('pdfTextPreview');
        const uploadForm = document.getElementById('uploadForm');
        
        // Data storage
        let extractedData = null;
        
        // Event listeners for drag and drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropZone.classList.add('dragover');
        }
        
        function unhighlight() {
            dropZone.classList.remove('dragover');
        }
        
        // Handle file drop
        dropZone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                handleFiles(files);
            }
        }
        
        // Handle file selection via button
        browseButton.addEventListener('click', function() {
            pdfFileInput.click();
        });
        
        pdfFileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFiles(this.files);
            }
        });
        
        // Handle the selected files
        function handleFiles(files) {
            if (files[0].type !== 'application/pdf') {
                alert('Please select a PDF file.');
                return;
            }
            
            // Update UI
            fileName.textContent = files[0].name;
            selectedFile.style.display = 'block';
            extractButton.disabled = false;
        }
        
        // Remove file
        removeFileButton.addEventListener('click', function() {
            pdfFileInput.value = '';
            fileName.textContent = 'No file selected';
            selectedFile.style.display = 'none';
            extractButton.disabled = true;
        });
        
        // Cancel upload
        cancelUpload.addEventListener('click', function() {
            window.location.href = "{{ url_for('index') }}";
        });
        
        // Navigation between tabs
        backToUpload.addEventListener('click', function() {
            new bootstrap.Tab(uploadTab).show();
        });
        
        backToPreview.addEventListener('click', function() {
            new bootstrap.Tab(previewTab).show();
        });
        
        continueToImport.addEventListener('click', function() {
            new bootstrap.Tab(importTab).show();
        });
        
        // Extract data from PDF
        extractButton.addEventListener('click', function() {
            // Check if template mode is selected
            const templateMode = document.getElementById('templateModeCheck').checked;
            
            if (!templateMode && !pdfFileInput.files[0]) {
                alert('Please select a PDF file first or use template mode.');
                return;
            }
            
            // Update button text based on mode
            if (templateMode) {
                extractButton.innerHTML = '<i class="fas fa-file-alt me-1"></i> Prepare Template';
            } else {
                extractButton.innerHTML = '<i class="fas fa-magic me-1"></i> Extract Data';
            }
            
            // Show progress with more detailed steps
            extractionProgress.style.display = 'block';
            extractionProgress.innerHTML = `
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 15%"></div>
                </div>
                <p class="text-center mb-1">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    ${templateMode ? 'Preparing template...' : 'Extracting text from PDF...'}
                </p>
                <p class="text-center text-muted small">
                    ${templateMode ? 'Creating a new template with placeholder fields' : 'This may take a moment for large files'}
                </p>
            `;
            
            extractButton.disabled = true;
            
            // Create FormData
            const formData = new FormData();
            
            if (templateMode) {
                // If using template mode, we still need a file but the contents don't matter as much
                if (pdfFileInput.files[0]) {
                    formData.append('pdf_file', pdfFileInput.files[0]);
                } else {
                    // Create a minimal placeholder PDF file
                    const blob = new Blob([''], { type: 'application/pdf' });
                    formData.append('pdf_file', blob, 'template.pdf');
                }
                formData.append('template_mode', 'true');
            } else {
                formData.append('pdf_file', pdfFileInput.files[0]);
                formData.append('template_mode', 'false');
            }
            
            // Send request
            fetch('{{ url_for("extract_pdf_preview") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Update progress
                const progressBar = extractionProgress.querySelector('.progress-bar');
                progressBar.style.width = '50%';
                extractionProgress.querySelector('p').innerHTML = `
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    ${templateMode ? 'Preparing form fields...' : 'Analyzing document structure...'}
                `;
                
                return response.json();
            })
            .then(data => {
                // Update progress
                const progressBar = extractionProgress.querySelector('.progress-bar');
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                
                // Hide progress after 1 second to show completion
                setTimeout(() => {
                    extractionProgress.style.display = 'none';
                }, 1000);
                
                // Check for warnings and errors
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Check for warning but not error
                if (data.warning && !data.error) {
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'alert alert-warning';
                    warningDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> ${data.warning}
                    `;
                    document.querySelector('#upload .col-md-8').appendChild(warningDiv);
                }
                
                // Store the extracted data
                extractedData = data.structured_data;
                
                // Update the preview
                updateTextPreview(data.text_preview, data.extraction_issues);
                
                // Update the import tab with extracted data
                updateDataSummary();
                
                // Check for extraction issues and display them
                if (data.extraction_issues && data.extraction_issues.length > 0) {
                    addExtractionIssuesAlert(data.extraction_issues, data.extraction_quality || 'low');
                }
                
                // Show preview tab
                document.querySelectorAll('.preview-section').forEach(el => {
                    el.style.display = 'block';
                });
                
                new bootstrap.Tab(previewTab).show();
            })
            .catch(error => {
                console.error('Error:', error);
                
                // Hide progress and show error message
                extractionProgress.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error extracting data: ${error.message || 'Unknown error'}
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="retryExtraction">
                            <i class="fas fa-redo me-1"></i> Try Again
                        </button>
                    </div>
                `;
                
                // Add retry button functionality
                document.getElementById('retryExtraction').addEventListener('click', function() {
                    extractionProgress.style.display = 'none';
                    extractButton.disabled = false;
                });
            });
        });
        
        // Function to update the text preview with extraction issues
        function updateTextPreview(textPreview, extractionIssues) {
            if (!textPreview || textPreview.trim() === '') {
                pdfTextPreview.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-file-alt fa-3x mb-3"></i>
                        <p>No text content could be extracted from this PDF.</p>
                        <p class="small">The file may be scanned or contain mostly images.</p>
                    </div>
                `;
                return;
            }
            
            // Show the text preview
            pdfTextPreview.innerHTML = `<pre>${textPreview}</pre>`;
            
            // Add extraction issues if present
            if (extractionIssues && extractionIssues.length > 0) {
                const tipDiv = document.createElement('div');
                tipDiv.className = 'extraction-tip mt-3';
                tipDiv.innerHTML = `
                    <h6><i class="fas fa-info-circle text-info me-2"></i>PDF Extraction Details</h6>
                    <p class="mb-2">The following issues were detected during extraction:</p>
                    <ul class="mb-0">
                        ${extractionIssues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                `;
                
                pdfTextPreview.appendChild(tipDiv);
            }
        }
        
        // Function to add extraction issues alert
        function addExtractionIssuesAlert(issues, quality) {
            const alertDiv = document.createElement('div');
            
            // Set alert class based on quality
            let alertClass = 'alert-warning';
            let icon = 'exclamation-triangle';
            let title = 'Extraction Issues Detected';
            
            if (quality === 'high') {
                alertClass = 'alert-success';
                icon = 'check-circle';
                title = 'Extraction Completed Successfully';
            } else if (quality === 'error') {
                alertClass = 'alert-danger';
                icon = 'times-circle';
                title = 'Extraction Failed';
            }
            
            alertDiv.className = `alert ${alertClass} mt-3`;
            alertDiv.innerHTML = `
                <h5><i class="fas fa-${icon} me-2"></i>${title}</h5>
                <ul class="mb-0">
                    ${issues.map(issue => `<li>${issue}</li>`).join('')}
                </ul>
            `;
            
            // Add advice based on quality
            if (quality === 'low' || quality === 'error') {
                const adviceDiv = document.createElement('div');
                adviceDiv.className = 'mt-2 pt-2 border-top';
                adviceDiv.innerHTML = `
                    <p class="mb-1"><strong>What you can do:</strong></p>
                    <ul class="mb-0">
                        <li>Try with a different PDF format (if available)</li>
                        <li>Make sure the PDF is not scanned or image-based</li>
                        <li>Check if the PDF has text layers</li>
                        <li>Continue with import and add missing data manually</li>
                    </ul>
                `;
                alertDiv.appendChild(adviceDiv);
            }
            
            // Add above the tabs
            const tabContent = document.getElementById('uploadTabsContent');
            tabContent.parentNode.insertBefore(alertDiv, tabContent);
        }
        
        // Function to check for empty data sections and provide guidance
        function checkEmptyDataSections(data) {
            let emptyCount = 0;
            const sections = [
                { name: 'cover_sheet', displayName: 'Organization Information', elementId: 'orgDataSummary' },
                { name: 'job_audit', displayName: 'Job Audit Information', elementId: 'jobDataSummary' },
                { name: 'section1', displayName: 'Section 1 Requirements', elementId: 'section1Summary' },
                { name: 'section2', displayName: 'Section 2 Requirements', elementId: 'section2Summary' },
                { name: 'section3', displayName: 'Section 3 Requirements', elementId: 'section3Summary' }
            ];
            
            sections.forEach(section => {
                const sectionData = data[section.name] || {};
                const isEmpty = Object.keys(sectionData).length === 0;
                
                if (isEmpty) {
                    emptyCount++;
                    
                    // Add help message to the section
                    const sectionElement = document.getElementById(section.elementId);
                    const helpDiv = document.createElement('div');
                    helpDiv.className = 'empty-section-help';
                    helpDiv.innerHTML = `
                        <i class="fas fa-info-circle me-1"></i>
                        No ${section.displayName.toLowerCase()} could be extracted from the PDF.
                        You may need to add this information manually after importing.
                    `;
                    
                    // Add the help div after the current content
                    sectionElement.appendChild(helpDiv);
                }
            });
            
            return emptyCount;
        }
        
        // Update data summary in import tab
        function updateDataSummary() {
            if (!extractedData) return;
            
            // Organization data
            const orgData = extractedData.cover_sheet || {};
            const orgDataSummary = document.getElementById('orgDataSummary');
            let orgHtml = '';
            
            if (Object.keys(orgData).length > 0) {
                for (const [key, value] of Object.entries(orgData)) {
                    if (value) {
                        const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        orgHtml += `
                            <div class="data-field">
                                <span class="field-name">${formattedKey}:</span>
                                <span class="field-value">${value}</span>
                            </div>
                        `;
                    }
                }
                // Add data quality indicator
                const qualityClass = Object.keys(orgData).length >= 5 ? 'quality-high' : 
                                    Object.keys(orgData).length >= 3 ? 'quality-medium' : 'quality-low';
                orgHtml += `
                    <div class="extraction-stats mt-2">
                        <span class="data-quality-indicator ${qualityClass}"></span>
                        Data quality: ${Object.keys(orgData).length >= 5 ? 'High' : 
                                      Object.keys(orgData).length >= 3 ? 'Medium' : 'Low'}
                        (${Object.keys(orgData).length} fields extracted)
                    </div>
                `;
            } else {
                orgHtml = '<div class="text-center text-muted py-3"><p>No organization data extracted</p></div>';
            }
            
            orgDataSummary.innerHTML = orgHtml;
            
            // Job audit data
            const jobData = extractedData.job_audit || {};
            const jobDataSummary = document.getElementById('jobDataSummary');
            let jobHtml = '';
            
            if (Object.keys(jobData).length > 0) {
                for (const [key, value] of Object.entries(jobData)) {
                    if (value) {
                        const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        jobHtml += `
                            <div class="data-field">
                                <span class="field-name">${formattedKey}:</span>
                                <span class="field-value">${value}</span>
                            </div>
                        `;
                    }
                }
                // Add data quality indicator
                const qualityClass = Object.keys(jobData).length >= 6 ? 'quality-high' : 
                                    Object.keys(jobData).length >= 3 ? 'quality-medium' : 'quality-low';
                jobHtml += `
                    <div class="extraction-stats mt-2">
                        <span class="data-quality-indicator ${qualityClass}"></span>
                        Data quality: ${Object.keys(jobData).length >= 6 ? 'High' : 
                                      Object.keys(jobData).length >= 3 ? 'Medium' : 'Low'}
                        (${Object.keys(jobData).length} fields extracted)
                    </div>
                `;
            } else {
                jobHtml = '<div class="text-center text-muted py-3"><p>No job audit data extracted</p></div>';
            }
            
            jobDataSummary.innerHTML = jobHtml;
            
            // Requirements data for each section
            ['section1', 'section2', 'section3'].forEach(section => {
                const sectionData = extractedData[section] || {};
                const sectionSummary = document.getElementById(`${section}Summary`);
                let sectionHtml = '';
                
                if (Object.keys(sectionData).length > 0) {
                    // Get the section number from section name (e.g., "1" from "section1")
                    const sectionNum = section.charAt(section.length - 1);
                    
                    // Calculate quality based on expected number of requirements
                    // CQI-9 has roughly: Section 1: ~15 reqs, Section 2: ~10 reqs, Section 3: ~15 reqs
                    let expectedReqs;
                    if (section === 'section1') expectedReqs = 15;
                    else if (section === 'section2') expectedReqs = 10;
                    else expectedReqs = 15;
                    
                    const extractionRatio = Object.keys(sectionData).length / expectedReqs;
                    const qualityClass = extractionRatio >= 0.7 ? 'quality-high' : 
                                        extractionRatio >= 0.4 ? 'quality-medium' : 'quality-low';
                    
                    sectionHtml = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${Object.keys(sectionData).length} requirements with evidence found</strong>
                            <span class="data-quality-indicator ${qualityClass}" 
                                title="Data quality: ${extractionRatio >= 0.7 ? 'High' : 
                                    extractionRatio >= 0.4 ? 'Medium' : 'Low'}"></span>
                        </div>
                        <div class="requirements-list">
                    `;
                    
                    // Sort requirements by ID
                    const sortedReqs = Object.entries(sectionData)
                        .map(([key, value]) => {
                            const reqId = key.replace('evidence_', '').replace('_', '.');
                            return { id: reqId, evidence: value };
                        })
                        .sort((a, b) => {
                            // Sort by numerical part of ID
                            const aNum = parseFloat(a.id.split('.')[1]);
                            const bNum = parseFloat(b.id.split('.')[1]);
                            return aNum - bNum;
                        });
                    
                    // Add requirements to the list
                    sortedReqs.forEach(req => {
                        sectionHtml += `
                            <div class="req-item">
                                <span class="req-id">${req.id}</span>
                                <span class="req-evidence">${req.evidence}</span>
                            </div>
                        `;
                    });
                    
                    sectionHtml += `
                        </div>
                        <div class="extraction-stats">
                            Estimated data quality: ${extractionRatio >= 0.7 ? 'High' : 
                                extractionRatio >= 0.4 ? 'Medium' : 'Low'}
                        </div>
                    `;
                } else {
                    sectionHtml = '<div class="text-center text-muted py-3"><p>No requirements data extracted</p></div>';
                }
                
                sectionSummary.innerHTML = sectionHtml;
            });
            
            // Show extraction metadata if available
            if (extractedData._metadata) {
                const meta = extractedData._metadata;
                const footer = document.createElement('div');
                footer.className = 'mt-4 text-muted small';
                footer.innerHTML = `
                    <p class="mb-1">Extraction completed: ${new Date(meta.extraction_timestamp).toLocaleString()}</p>
                    <p class="mb-1">PDF file: ${meta.pdf_filename} (${Math.round(meta.pdf_size_bytes / 1024)} KB)</p>
                    <p class="mb-0">Extracted text: ${meta.text_extract_length} characters</p>
                `;
                
                // Add to the bottom of the import tab
                const importTab = document.getElementById('import');
                importTab.querySelector('.row').appendChild(footer);
            }
        }
        
        // Import button
        importButton.addEventListener('click', function() {
            if (!extractedData) {
                alert('No data to import. Please extract data from a PDF first.');
                return;
            }
            
            // Disable the button and show loading state
            importButton.disabled = true;
            importButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Importing Data...
            `;
            
            // Create hidden form to submit the extracted data
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("upload_audit") }}';
            
            // Create a hidden input for the file
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.name = 'pdf_file';
            fileInput.files = pdfFileInput.files;
            fileInput.style.display = 'none';
            
            // Add a status message
            const statusDiv = document.createElement('div');
            statusDiv.className = 'alert alert-info mt-3';
            statusDiv.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                Importing data and preparing audit form...
            `;
            importButton.parentNode.appendChild(statusDiv);
            
            // Append the input to the form
            form.appendChild(fileInput);
            
            // Append the form to the document and submit it
            document.body.appendChild(form);
            
            try {
                form.submit();
                
                // Add a redirect message after submission
                setTimeout(() => {
                    statusDiv.className = 'alert alert-success mt-3';
                    statusDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        Data import successful! Redirecting to audit form...
                    `;
                }, 1000);
            } catch (error) {
                console.error('Form submission error:', error);
                
                // Show error message
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error importing data: ${error.message || 'Unknown error'}
                `;
                
                // Re-enable the button
                importButton.disabled = false;
                importButton.innerHTML = `
                    <i class="fas fa-file-import me-1"></i> Import Data
                `;
            }
        });
        
        // Handle checkbox for template mode
        const templateModeCheck = document.getElementById('templateModeCheck');
        templateModeCheck.addEventListener('change', function() {
            if (this.checked) {
                // Enable the extract button even if no file is selected
                extractButton.disabled = false;
                extractButton.innerHTML = '<i class="fas fa-file-alt me-1"></i> Prepare Template';
                
                // Add notice about template mode
                let templateNotice = document.getElementById('templateNotice');
                if (!templateNotice) {
                    templateNotice = document.createElement('div');
                    templateNotice.id = 'templateNotice';
                    templateNotice.className = 'alert alert-info mt-3';
                    templateNotice.innerHTML = `
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Template Mode:</strong> You'll get a pre-filled form with placeholders that you can edit manually.
                        ${pdfFileInput.files[0] ? 'Your selected PDF will still be attached to the audit.' : 'You can optionally select a PDF to attach to the audit.'}
                    `;
                    document.querySelector('#uploadForm').insertBefore(templateNotice, extractButton.parentNode);
                }
            } else {
                // Return to normal mode
                extractButton.innerHTML = '<i class="fas fa-magic me-1"></i> Extract Data';
                extractButton.disabled = !pdfFileInput.files[0];
                
                // Remove the template notice if it exists
                const templateNotice = document.getElementById('templateNotice');
                if (templateNotice) {
                    templateNotice.remove();
                }
            }
        });
    });
</script>
{% endblock %} 